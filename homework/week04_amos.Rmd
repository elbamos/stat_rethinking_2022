---
title: "Week 4"
output: html_notebook
---

```{r setup}
library(rethinking)
library(dplyr)
library(ggplot2)
```

## Question 1

Revisit the marriage, age, and happiness collider bias example from Chapter 6. Run models m6.9 and m6.10 again (pages 178â€“179). Compare these two models using both PSIS and WAIC. Which model is expected to make better predictions, according to these criteria? On the basis of the causal model, how should you interpret the parameter estimates from the model preferred by PSIS and WAIC?

```{r question_1_setup}
d <- sim_happiness(seed=1974, N_years = 1000)
d2 <- d |>
  filter(age >= 18) |> 
  mutate(
    A = (age - min(age)) / (65 - min(age)),
    mid = married + 1
  )

m6.9 <- quap(
  alist(
    happiness ~ dnorm(mu, sigma), 
    mu <- a[mid] + bA*A, 
    a[mid] ~ dnorm(0, 1),
    bA ~ dnorm(0, 2), 
    sigma ~ dexp(1)
  ), 
  data = d2
)

m6.10 <- quap(
  alist(
    happiness ~ dnorm(mu, sigma), 
    mu <- a + bA*A, 
    a ~ dnorm(0, 1),
    bA ~ dnorm(0, 2), 
    sigma ~ dexp(1)
  ), 
  data = d2
)
```

```{r question_1_waic}
compare(m6.9, m6.10)
```

```{r question_1_psis}
compare(m6.9, m6.10, func=PSIS)
```

## Question 2

```{r question_2_setup}
data(foxes)
model_2_t <- quap(
  alist(
    weight ~ dnorm(mu, sigma), 
    mu <- alpha + bF * avgfood, 
    alpha ~ dnorm(0, 0.5), 
    bF ~ dnorm(0, 0.5), 
    sigma ~ dexp(1)
  ), 
  data = foxes |> mutate_all(scale)
)

model_2_d <- quap(
  alist(
    weight ~ dnorm(mu, sigma), 
    mu <- alpha + bF * avgfood + bG * groupsize, 
    alpha ~ dnorm(0, 0.5), 
    bF ~ dnorm(0, 0.5), 
    bG ~ dnorm(0, 0.5), 
    sigma ~ dexp(1),
    groupsize ~ dnorm(mu_g, sigma_g), 
    mu_g <- alpha_g + bFG * avgfood,
    alpha_g ~ dnorm(0, 0.5),
    bFG ~ dnorm(0, 0.5), 
    sigma_g ~ dexp(1)
  ), 
  data = foxes |> mutate_all(scale)
)

compare(model_2_d, model_2_t, func=PSIS)
```

## Question 3

Build a predictive model of the relationship show on the cover of the book, the relationship between the timing of cherry blossoms and March temperature in the same year. The data are found in data(cherry_blossoms). Consider at least two functions to predict doy with temp. Compare them with PSIS or WAIC.

```{r question_3_setup}
data("cherry_blossoms")
cherry_data <- cherry_blossoms |> filter(! is.na(doy), ! is.na(temp)) 
plot(cherry_data$temp, cherry_data$doy)
```

```{r question_3_models}
q3_linear <- quap(
  alist(
    doy ~ dnorm(mu, sigma), 
    sigma ~ dexp(1), 
    mu <- a + bT * temp, 
    a ~ dnorm(0, 0.2), 
    bT ~ dnorm(0, 0.2)
  ), 
  data <- cherry_data |> mutate(doy = scale(doy), temp = scale(temp))
)

q3_quad <- quap(
  alist(
    doy ~ dnorm(mu, sigma), 
    sigma ~ dexp(1), 
    mu <- a + bT * temp + bT2 * temp^2, 
    a ~ dnorm(0, 0.2), 
    bT ~ dnorm(0, 0.2),
    bT2 ~ dnorm(0, 0.2)
  ), 
  data <- cherry_data |> mutate(doy = scale(doy), temp = scale(temp))
)

compare(q3_linear, q3_quad, func = PSIS)
```


Suppose March temperatures reach 9 degrees by the year 2050. What does your best model predict for the predictive distribution of the day-in-year that the cherry trees will blossom?

```{r question_3_prediction}
degrees <- (9 * sd(cherry_data$temp)) + mean(cherry_data$temp)
q3_samples <- sim(q3_linear, data = list(temp = degrees))
q3_samples <- (q3_samples * sd(cherry_data$doy)) + mean(cherry_data$doy)
dens(q3_samples)
```

## Question 4

```{r question_4_data_vis}
data(Dinosaurs)
library(ggplot2)
Dinosaurs |> 
  ggplot(aes(x = age, y = mass)) + 
  geom_point(size = 0.5) + 
  facet_wrap(~ species, scales = "free")
```

```{r question_4_models}
q4_linear <- quap(
  alist(
    mass ~ dlnorm(mu, sigma),
    mu <- a[sp_id] + bA[sp_id] * age, 
    a[sp_id] ~ dnorm(5, 1),
    bA[sp_id] ~ dnorm(0, 1), 
    sigma ~ dexp(1)
  ), 
  data = Dinosaurs
)

q4_quad <- quap(
  alist(
    mass ~ dlnorm(mu, sigma),
    mu <- a[sp_id] + bA[sp_id] * age + bA2[sp_id] * age^2, 
    a[sp_id] ~ dnorm(5, 1),
    bA[sp_id] ~ dnorm(0, 1),
    bA2[sp_id] ~ dnorm(0, 1), 
    sigma ~ dexp(1)
  ), 
  data = Dinosaurs
)

q4_quad0 <- quap(
  alist(
    mass ~ dlnorm(mu, sigma),
    mu <- bA[sp_id] * age + bA2[sp_id] * age^2, 
    bA[sp_id] ~ dnorm(0, 1),
    bA2[sp_id] ~ dnorm(0, 1), 
    sigma ~ dexp(1)
  ), 
  data = Dinosaurs
)

compare(q4_linear, q4_quad, q4_quad0, func = PSIS)
```

```{r compare_waic}
compare(q4_linear, q4_quad, q4_quad0)
```

```{r growth_curves}
coefs <- coef(q4_quad0)
args <- data.frame(
  bA = coefs[1:6], 
  bA2 = coefs[7:12]
)

func <- function(age, bA, bA2) exp(bA * age + bA2 * age^2)

Dinosaurs |> 
  ggplot(aes(x = age, y = mass)) + 
  geom_point(size = 0.5) + 
  geom_function(
    fun = func, 
    args = args[1, ], 
    data = data.frame(sp_id = 1, age = 1, mass = 1), 
    size = 0.1, color = "blue"
  ) +
  geom_function(
    fun = func, 
    args = args[2, ], 
    data = data.frame(sp_id = 2, age = 1, mass = 1), 
    size = 0.1, color = "blue"
  ) +
  geom_function(
    fun = func, 
    args = args[3, ], 
    data = data.frame(sp_id = 3, age = 1, mass = 1), 
    size = 0.1, color = "blue"
  ) +
  geom_function(
    fun = func, 
    args = args[4, ], 
    data = data.frame(sp_id = 4, age = 1, mass = 1), 
    size = 0.1, color = "blue"
  ) +
  geom_function(
    fun = func, 
    args = args[5, ], 
    data = data.frame(sp_id = 5, age = 1, mass = 1), 
    size = 0.1, color = "blue"
  ) +
  geom_function(
    fun = func, 
    args = args[6, ], 
    data = data.frame(sp_id = 6, age = 1, mass = 1), 
    size = 0.1, color = "blue"
  ) +
  facet_wrap(~ sp_id, scales = "free") 
```

